from typing import Any, List, Dict

import attr
from flask import jsonify, request
from dialogy.types.intent import Intent

from [[ python_package_import_name ]].api import app
from [[ python_package_import_name ]] import constants
from [[ python_package_import_name ]].controller.prediction import predict_wrapper


@app.route("/", methods=["GET"])
def health_check():
    return jsonify(
        status="ok",
        response={"message": "Server is up."},
    )


@app.route("/predict/<lang>/<project_name>/", methods=["POST"])
def slu(_, __):
    utterance: List[List[Dict[str, Any]]] = request.json.get(constants.ALTERNATIVES)
    context: str = request.json.get(constants.CONTEXT)

    predict = predict_wrapper()

    if not utterance:
        utterance = [[{constants.TRANSCRIPT: request.json.get(constants.TEXT)}]]

    if not utterance:
        return {constants.INTENTS: [attr.asdict(Intent(name="_oos_", score=1))]}

    response = predict(utterance, context)

    return jsonify(status="ok", response=response)
